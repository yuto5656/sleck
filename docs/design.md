# Sleck システム設計書

## 1. システム概要

### 1.1 目的
Slack風のリアルタイムメッセージングアプリケーションを提供する。

### 1.2 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client (Browser)                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    React Application                      │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │    │
│  │  │ Channels │ │ Messages │ │  Users   │ │  Search  │   │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │    │
│  │                      ↓                                    │    │
│  │  ┌────────────────────────────────────────────────────┐ │    │
│  │  │              Zustand Store (状態管理)                │ │    │
│  │  └────────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────┘    │
│                    ↓ HTTP/REST        ↓ WebSocket                │
└─────────────────────────────────────────────────────────────────┘
                     ↓                   ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Server (Node.js)                            │
│  ┌──────────────────────┐    ┌──────────────────────────────┐   │
│  │    Express (REST)     │    │      Socket.io (Real-time)   │   │
│  │  ┌────────────────┐  │    │  ┌────────────────────────┐  │   │
│  │  │   Controllers  │  │    │  │    Event Handlers      │  │   │
│  │  └────────────────┘  │    │  └────────────────────────┘  │   │
│  └──────────────────────┘    └──────────────────────────────┘   │
│                    ↓                        ↓                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Services Layer                          │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │   │
│  │  │  Auth    │ │ Message  │ │ Channel  │ │   File   │    │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              ↓                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Prisma ORM                              │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      PostgreSQL                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  Users   │ │ Channels │ │ Messages │ │  Files   │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

## 2. アーキテクチャ

### 2.1 フロントエンド
- **React 18**: UIフレームワーク
- **TypeScript**: 型安全性
- **Vite**: 高速なビルドツール
- **Zustand**: 軽量な状態管理
- **TailwindCSS**: ユーティリティファーストCSS
- **Socket.io-client**: リアルタイム通信

### 2.2 バックエンド
- **Express.js**: REST APIフレームワーク
- **Socket.io**: WebSocket実装
- **Prisma**: 型安全なORM
- **JWT**: トークンベース認証
- **bcrypt**: パスワードハッシュ化
- **multer**: ファイルアップロード処理

### 2.3 データベース
- **PostgreSQL**: メインデータストア
- **Redis** (オプション): セッション/キャッシュ

## 3. 認証・セキュリティ

### 3.1 認証フロー

```
1. ユーザー登録/ログイン
   Client → POST /api/auth/login → Server

2. JWT発行
   Server → JWT (Access Token + Refresh Token) → Client

3. 認証付きリクエスト
   Client → Authorization: Bearer <token> → Server

4. トークンリフレッシュ
   Client → POST /api/auth/refresh → Server → 新しいJWT
```

### 3.2 セキュリティ対策
- パスワードはbcryptでハッシュ化（ソルト付き）
- JWTは短い有効期限（15分）+ リフレッシュトークン（7日）
- CORS設定による許可オリジン制限
- Rate Limiting（API呼び出し制限）
- XSS対策（入力サニタイズ）
- CSRF対策（トークンベース）

## 4. リアルタイム通信

### 4.1 WebSocket イベント

| イベント名 | 方向 | 説明 |
|-----------|------|------|
| `message:send` | Client→Server | メッセージ送信 |
| `message:new` | Server→Client | 新着メッセージ通知 |
| `message:update` | Server→Client | メッセージ更新通知 |
| `message:delete` | Server→Client | メッセージ削除通知 |
| `typing:start` | Client→Server | 入力開始通知 |
| `typing:stop` | Client→Server | 入力停止通知 |
| `user:online` | Server→Client | ユーザーオンライン通知 |
| `user:offline` | Server→Client | ユーザーオフライン通知 |
| `channel:join` | Client→Server | チャンネル参加 |
| `channel:leave` | Client→Server | チャンネル退出 |
| `reaction:add` | Client→Server | リアクション追加 |
| `reaction:remove` | Client→Server | リアクション削除 |

### 4.2 ルーム設計

```
Socket.io Rooms:
├── workspace:{workspaceId}     # ワークスペース全体
├── channel:{channelId}         # チャンネル
├── dm:{dmId}                   # ダイレクトメッセージ
└── user:{userId}               # ユーザー個人通知
```

## 5. ファイル管理

### 5.1 対応ファイル形式
- 画像: jpg, png, gif, webp
- 文書: pdf, doc, docx, xls, xlsx
- その他: zip, txt, md

### 5.2 制限事項
- 最大ファイルサイズ: 50MB
- 1メッセージあたり最大ファイル数: 10

### 5.3 ストレージ
- ローカルストレージ（開発）
- S3互換ストレージ（本番）※オプション

## 6. 検索機能

### 6.1 検索対象
- メッセージ本文
- ファイル名
- ユーザー名
- チャンネル名

### 6.2 検索フィルター
- チャンネル指定
- ユーザー指定
- 日付範囲
- ファイル種類

## 7. 通知機能

### 7.1 通知種類
- メンション通知（@user, @channel, @here）
- ダイレクトメッセージ通知
- スレッド返信通知
- リアクション通知

### 7.2 通知設定
- 全通知
- メンションのみ
- 通知なし
- スケジュール（時間帯指定）
